<header id="header" class="header d-flex align-items-center sticky-top p-0"
    *ngIf="isAuthResolved$ | async; else loading">
    <div class="container-fluid container-xl position-relative d-flex align-items-center justify-content-between">
        <a href="/" class="logo d-flex align-items-center">
            <h1>VLE</h1>
        </a>

        <!-- Desktop Navigation -->
        <nav id="navmenu" class="navmenu d-flex w-100 justify-content-between">
            <ul class="navmenu-center d-flex justify-content-center d-none d-lg-flex">
                <li *ngIf="(isLoggedIn$ | async)">
                    <a aria-current="page" href="/">Home</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async)">
                    <a aria-current="page" href="/explore">Explore</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async) && !(isAdmin$ | async)">
                    <a aria-current="page" href="/contact">Contact</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async) && (isAdmin$ | async)">
                    <a aria-current="page" href="/create-module">Create Module</a>
                </li>
            </ul>

            <ul class="navmenu-right d-flex justify-content-end d-none d-lg-flex gap-0">
                <ng-container *ngIf="(isLoggedIn$ | async); else loggedOut">
                    <!-- Notification Bell -->
                    <li *ngIf="(isLoggedIn$ | async)">
                        <app-notification></app-notification>
                    </li>
                    
                    <!-- Welcome User Dropdown -->
                    <li id="userDropdownContainer" class="nav-item dropdown" [class.show]="isUserMenuOpen">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" 
                           role="button" 
                           [attr.aria-expanded]="isUserMenuOpen" 
                           (click)="toggleDropdown($event)">
                            Welcome, {{ (currentUser$ | async)?.firstName || 'Unknown' }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" [class.show]="isUserMenuOpen">
                            <li>
                                <a class="dropdown-item" (click)="logout()" style="cursor: pointer;">
                                    <i class="bi bi-box-arrow-right me-1"></i>
                                    Logout
                                </a>
                            </li>
                        </ul>
                    </li>
                </ng-container>

                <ng-template #loggedOut>
                    <li>
                        <button class="btn btn-primary" (click)="navigateTo('/login')">Login</button>
                    </li>
                    <li>
                        <button class="btn btn-outline-primary" (click)="navigateTo('/register')">Register</button>
                    </li>
                </ng-template>
            </ul>
        </nav>

        <!-- Mobile Navigation -->
        <button class="mobile-nav-toggle d-lg-none" (click)="toggleMobileMenu()">
            <span [class]="mobileMenuOpen ? 'bi bi-x' : 'bi bi-list'"></span>
        </button>

        <div class="mobile-nav-overlay" *ngIf="mobileMenuOpen" (click)="toggleMobileMenu()"></div>
        <div class="mobile-nav-menu d-lg-none" *ngIf="mobileMenuOpen">
            <ul>
                <li *ngIf="(isLoggedIn$ | async)">
                    <a aria-current="page" href="/">Home</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async)">
                    <a aria-current="page" href="/explore">Explore</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async) && !(isAdmin$ | async)">
                    <a aria-current="page" href="/contact">Contact</a>
                </li>
                <li *ngIf="(isLoggedIn$ | async) && (isAdmin$ | async)">
                    <a aria-current="page" href="/create-module">Create Module</a>
                </li>

                <hr *ngIf="(isLoggedIn$ | async)">

                <li *ngIf="(isLoggedIn$ | async)" class="notification-mobile">
                    <app-notification></app-notification>
                </li>
                
                <span class="small" *ngIf="(isLoggedIn$ | async)">Welcome, {{ (currentUser$ | async)?.firstName || 'Unknown' }}</span>
                <li *ngIf="(isLoggedIn$ | async)">
                    <a (click)="logout()">Logout</a>
                </li>
                <ng-container *ngIf="!(isLoggedIn$ | async)">
                    <li>
                        <a href="/login">Login</a>
                    </li>
                    <li>
                        <a href="/register">Register</a>
                    </li>
                </ng-container>
            </ul>
        </div>
    </div>
</header>

<ng-template #loading>
    <div class="spinner-container">
        <mat-spinner></mat-spinner>
    </div>
</ng-template>